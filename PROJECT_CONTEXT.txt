================================================================================
                    CHECKBUS PROJECT - CONTEXT DOCUMENTATION
================================================================================

PROJECT OVERVIEW
================================================================================
CheckBus is a modern urban transportation management system designed to 
modernize bus transportation services using a Service-Oriented Architecture 
(SOA) / Microservices approach. The system enables users to search for bus 
routes, purchase tickets, manage subscriptions, track bus locations in 
real-time, and handle payments seamlessly.

The project follows a microservices architecture pattern with multiple 
independent services communicating through REST APIs and Apache Kafka for 
event-driven messaging.

================================================================================
ARCHITECTURE OVERVIEW
================================================================================

ARCHITECTURE TYPE: Microservices / SOA
COMMUNICATION: REST APIs + Apache Kafka (Event-Driven)
API GATEWAY: Nginx (Reverse Proxy & Load Balancer)
FRONTEND: React.js (Single Page Application)
DATABASES: PostgreSQL (one per service for data isolation)
CACHING: Redis (for geolocation service)
MESSAGE BROKER: Apache Kafka with Zookeeper

================================================================================
MICROSERVICES & MAIN FUNCTIONALITIES
================================================================================

1. AUTHENTICATION SERVICE (auth-service)
   Port: 8084
   Database: auth_db (PostgreSQL)
   
   Main Functionalities:
   - User Registration with email verification
   - User Login with JWT token generation
   - Password Reset (forgot password flow)
   - Email Verification (token-based)
   - Token Validation
   - Resend Verification Email
   - Remember Me functionality (30-day token vs session token)
   - JWT-based authentication
   - Email notifications via SMTP (Gmail)

   Key Endpoints:
   - POST /api/auth/register - Register new user
   - POST /api/auth/login - User login
   - GET /api/auth/verify - Verify JWT token
   - POST /api/auth/forgot-password - Request password reset
   - POST /api/auth/reset-password - Reset password with token
   - POST /api/auth/verify-email - Verify email with token
   - POST /api/auth/resend-verification - Resend verification email


2. USER SERVICE (user-service)
   Port: 8082
   Database: user_db (PostgreSQL)
   
   Main Functionalities:
   - User Profile Management
   - Create, Read, Update, Delete user accounts
   - Search users by username
   - Get user by ID, username, or email
   - User data synchronization with auth service

   Key Endpoints:
   - POST /api/users - Create new user
   - GET /api/users/{id} - Get user by ID
   - GET /api/users/username/{username} - Get user by username
   - GET /api/users/email/{email} - Get user by email
   - GET /api/users/search?q={keyword} - Search users
   - PUT /api/users/{id} - Update user
   - DELETE /api/users/{id} - Delete user
   - GET /api/users - Get all users


3. TICKET SERVICE (ticket-service)
   Port: 8081
   Database: ticket_db (PostgreSQL)
   Dependencies: Payment Service, Trajet Service, Kafka
   
   Main Functionalities:
   - Ticket Reservation (15-minute hold period)
   - Ticket Purchase (with payment integration)
   - Ticket Modification/Change
   - Ticket Cancellation (with refund processing)
   - View tickets by user ID
   - View tickets by trip ID
   - Ticket expiration handling (via Kafka events)
   - Seat availability checking
   - Ticket history tracking
   - Automatic ticket expiration after 15 minutes if not purchased

   Key Endpoints:
   - POST /api/tickets/reserve - Reserve a ticket (15 min hold)
   - POST /api/tickets/{ticketId}/buy - Purchase reserved ticket
   - PUT /api/tickets/{ticketId}/change - Modify ticket details
   - DELETE /api/tickets/{ticketId}/cancel - Cancel ticket (with refund)
   - GET /api/tickets/user/{userId} - Get all tickets for a user
   - GET /api/tickets/trip/{tripId} - Get all tickets for a trip

   Ticket Statuses:
   - RESERVED: Ticket is reserved but not paid
   - PAID: Ticket is purchased and paid
   - VALIDATED: Ticket has been used/validated
   - CANCELLED: Ticket has been cancelled
   - EXPIRED: Reservation expired without purchase


4. PAYMENT SERVICE (payment-service)
   Port: 8085
   Database: payment_db (PostgreSQL)
   Integration: Stripe Payment Gateway
   Dependencies: Kafka
   
   Main Functionalities:
   - Process ticket payments via Stripe
   - Process subscription payments
   - Payment refunds
   - Payment status tracking
   - Payment history retrieval
   - Payment event publishing (Kafka)
   - Support for card payments
   - Payment reference generation

   Key Endpoints:
   - POST /api/payments/process - Process ticket payment
   - POST /api/payments/subscribe - Process subscription payment
   - POST /api/payments/refund - Process refund
   - GET /api/payments/ticket/{ticketId} - Get payments for a ticket
   - GET /api/payments/successful - Get all successful payments

   Payment Statuses:
   - PENDING: Payment initiated
   - SUCCESS: Payment completed
   - FAILED: Payment failed
   - REFUNDED: Payment refunded


5. TRAJET SERVICE (trajet-service)
   Port: 8083
   Database: trajet_db (PostgreSQL)
   Dependencies: Kafka
   
   Main Functionalities:
   - Route/Trajectory Management
   - Search routes by departure and arrival stations
   - Create, update, delete routes
   - Schedule Management (Horaires)
   - Route information (stops, distance, active status)
   - Route availability checking

   Key Endpoints:
   - GET /api/trajets - Get all routes
   - GET /api/trajets/{id} - Get route by ID
   - GET /api/trajets/search?depart={depart}&arrivee={arrivee} - Search routes
   - POST /api/trajets - Create new route
   - PUT /api/trajets/{id} - Update route
   - DELETE /api/trajets/{id} - Delete route
   - GET /api/horaires/trajet/{trajetId} - Get schedules for a route
   - POST /api/horaires/trajet/{trajetId} - Add schedule to route

   Route Information:
   - Line code (e.g., "Ligne 3")
   - Departure station
   - Arrival station
   - Intermediate stops (arrets)
   - Distance in kilometers
   - Active/inactive status


6. SUBSCRIPTION SERVICE (subscription-service)
   Port: 8087
   Database: subscription_db (PostgreSQL)
   Dependencies: User Service, Payment Service, Kafka
   
   Main Functionalities:
   - Create subscriptions (Monthly or Annual plans)
   - Auto-renewal management
   - Subscription cancellation
   - Cancel auto-renewal
   - Get user subscriptions
   - Subscription status tracking
   - Automatic payment processing for subscriptions

   Key Endpoints:
   - POST /api/subscriptions/create - Create subscription
   - GET /api/subscriptions/user/{userId} - Get user subscriptions
   - POST /api/subscriptions/cancel-auto - Cancel auto-renewal
   - POST /api/subscriptions/cancel-subscription - Cancel subscription

   Subscription Plans:
   - MONTHLY: 49 MAD per month
   - ANNUAL: Yearly subscription (pricing defined in service)

   Subscription Statuses:
   - PENDING: Subscription created, payment pending
   - ACTIVE: Subscription active and paid
   - CANCELED: Subscription cancelled
   - EXPIRED: Subscription expired


7. GEOLOCATION SERVICE (geoloc-service)
   Port: 8089
   Database: geolocdb (PostgreSQL)
   Cache: Redis
   Dependencies: Kafka, WebSocket support
   
   Main Functionalities:
   - Real-time bus position tracking
   - Bus location updates (via HTTP or WebSocket)
   - Get latest bus position
   - Get all bus positions (for dashboard)
   - Get historical positions for a bus
   - Redis caching for fast position retrieval
   - WebSocket support for real-time updates
   - Kafka event publishing for position updates

   Key Endpoints:
   - POST /api/geo/update - Update bus position (HTTP)
   - GET /api/geo/{busId} - Get latest position for a bus
   - GET /api/geo/bus/{busId}/all - Get all positions for a bus
   - GET /api/geo/all - Get all latest bus positions

   WebSocket:
   - Message Mapping: /bus/update
   - Topic: /topic/bus/positions

   Position Data:
   - Bus ID
   - Latitude/Longitude
   - Direction (FORWARD/BACKWARD)
   - Timestamp


8. NOTIFICATION SERVICE (notification-service)
   Port: (configured but minimal implementation)
   Database: (PostgreSQL)
   
   Main Functionalities:
   - Email notifications
   - SMS notifications (planned)
   - Event-driven notifications via Kafka
   - Integration with other services for user notifications

   Note: Service structure exists but implementation appears minimal in 
   current codebase.


================================================================================
FRONTEND FEATURES (React.js Application)
================================================================================

The frontend is a React.js Single Page Application (SPA) with the following 
main pages and features:

1. LOGIN PAGE (/)
   - User authentication
   - Login form with username/password
   - Remember me option
   - Redirect to registration

2. REGISTRATION PAGE (/register)
   - New user registration
   - Email verification flow

3. MENU/DASHBOARD (/)
   - Main navigation hub after login
   - Access to all features

4. BUY TICKET PAGE (/buy-ticket)
   - Search for bus routes
   - Select departure and arrival stations
   - View available buses and schedules
   - View bus status (On Time, Delayed)
   - Select bus and reserve seat
   - View pricing information

5. RESERVE SEAT PAGE (/reserve-seat/:busId)
   - Seat selection interface
   - View available/occupied seats
   - Reserve specific seat
   - 15-minute reservation hold

6. PAYMENT PAGE (/payment)
   - Payment processing interface
   - Stripe payment integration
   - Payment confirmation

7. SUBSCRIPTIONS PAGE (/subscriptions)
   - View available subscription plans
   - Monthly and Annual plans
   - Create new subscription
   - View active subscriptions
   - Manage auto-renewal

8. SUBSCRIPTION CHECKOUT (/checkout)
   - Subscription payment processing
   - Plan selection and payment

9. PROFILE PAGE (/profile)
   - User profile information
   - View and edit user details
   - View ticket history
   - View subscription history

10. MODIFY TICKET PAGE (/tickets/:ticketId/modify)
    - Modify existing ticket
    - Change route, date, or seat
    - Update ticket information

11. MAP PAGE (/map)
    - Real-time bus tracking on map
    - Interactive map with Leaflet
    - Bus position markers
    - Bus stop markers
    - Route visualization
    - Real-time position updates

12. PAYMENTS DASHBOARD (/payments)
    - View payment history
    - Successful payments
    - Payment status tracking


================================================================================
INFRASTRUCTURE COMPONENTS
================================================================================

1. NGINX API GATEWAY
   - Port: 80
   - Function: Reverse proxy and load balancer
   - Routes all API requests to appropriate microservices
   - Single entry point for all backend services

2. APACHE KAFKA
   - Port: 9092 (external), 29092 (internal)
   - Function: Event-driven messaging between services
   - Topics for: Payment events, Ticket events, Subscription events, 
                 Trajet events, Bus position events

3. ZOOKEEPER
   - Port: 2181
   - Function: Coordination service for Kafka

4. KAFKA UI
   - Port: 8080
   - Function: Web interface for monitoring Kafka topics and messages

5. REDIS
   - Port: 6379
   - Function: Caching layer for geolocation service
   - Fast retrieval of latest bus positions

6. POSTGRESQL DATABASES
   - Multiple databases (one per service):
     * auth_db (port: internal)
     * user_db (port: internal)
     * ticket_db (port: internal)
     * payment_db (port: internal)
     * trajet_db (port: internal)
     * subscription_db (port: internal)
     * geolocdb (port: 5433 external)

7. PGADMIN
   - Port: 5050
   - Function: Database administration interface
   - Access to all PostgreSQL databases


================================================================================
TECHNOLOGY STACK
================================================================================

BACKEND:
- Java 17
- Spring Boot 3.x
- Spring Data JPA
- Spring Security
- Spring Kafka
- PostgreSQL
- Redis
- Apache Kafka
- Stripe API (Payment processing)
- JWT (JSON Web Tokens)
- SMTP (Email notifications)

FRONTEND:
- React.js
- React Router
- Tailwind CSS
- Leaflet (Maps)
- Lucide React (Icons)

INFRASTRUCTURE:
- Docker & Docker Compose
- Nginx
- PostgreSQL
- Redis
- Apache Kafka
- Zookeeper

DEVELOPMENT TOOLS:
- Maven (Java build tool)
- Node.js & npm (Frontend)


================================================================================
KEY BUSINESS FLOWS
================================================================================

1. USER REGISTRATION FLOW:
   User → Auth Service → Email Verification → User Service (create profile)

2. TICKET PURCHASE FLOW:
   User → Frontend → Trajet Service (search routes) → Ticket Service 
   (reserve) → Payment Service (process payment) → Ticket Service 
   (confirm purchase) → Kafka Event (notification)

3. SUBSCRIPTION FLOW:
   User → Subscription Service (create) → Payment Service (process) → 
   Subscription Service (activate) → Kafka Event

4. BUS TRACKING FLOW:
   Bus → Geoloc Service (update position) → Redis (cache) → Kafka Event → 
   Frontend (WebSocket/HTTP polling) → Map Display

5. TICKET EXPIRATION FLOW:
   Ticket Service (reserve) → Kafka (delayed event) → Ticket Service 
   (expire if not purchased)

6. PAYMENT REFUND FLOW:
   Ticket Service (cancel) → Payment Service (refund) → Kafka Event


================================================================================
SERVICE COMMUNICATION PATTERNS
================================================================================

1. SYNCHRONOUS (REST):
   - Service-to-service REST calls for immediate responses
   - Example: Ticket Service → Payment Service (payment processing)
   - Example: Subscription Service → User Service (get user info)

2. ASYNCHRONOUS (KAFKA):
   - Event-driven communication for decoupled services
   - Example: Payment events, Ticket expiration events, Subscription events
   - Example: Bus position updates

3. CACHING (REDIS):
   - Fast data retrieval for frequently accessed data
   - Example: Latest bus positions in Geoloc Service


================================================================================
SECURITY FEATURES
================================================================================

- JWT-based authentication
- Password encryption (BCrypt)
- Email verification for new users
- Token-based password reset
- Secure cookie handling
- CORS configuration
- API Gateway for centralized routing
- Service isolation (separate databases)


================================================================================
DEPLOYMENT
================================================================================

The entire system is containerized using Docker Compose:
- All services run in Docker containers
- Each service has its own Dockerfile
- docker-compose.yml orchestrates all services
- Environment variables for configuration
- Volume persistence for databases
- Health checks for critical services


================================================================================
MAIN FUNCTIONALITIES SUMMARY
================================================================================

USER MANAGEMENT:
✓ User registration with email verification
✓ User authentication and authorization
✓ Password reset functionality
✓ User profile management

TICKET MANAGEMENT:
✓ Search and browse bus routes
✓ Reserve tickets (15-minute hold)
✓ Purchase tickets with payment
✓ Modify existing tickets
✓ Cancel tickets with refunds
✓ View ticket history

PAYMENT PROCESSING:
✓ Stripe payment integration
✓ Ticket payment processing
✓ Subscription payment processing
✓ Payment refunds
✓ Payment history tracking

SUBSCRIPTION MANAGEMENT:
✓ Monthly and Annual subscription plans
✓ Auto-renewal management
✓ Subscription cancellation
✓ Subscription status tracking

ROUTE MANAGEMENT:
✓ Route creation and management
✓ Route search by departure/arrival
✓ Schedule (Horaire) management
✓ Route availability tracking

REAL-TIME TRACKING:
✓ Real-time bus position tracking
✓ Interactive map with bus locations
✓ Historical position data
✓ WebSocket support for live updates

NOTIFICATIONS:
✓ Email notifications
✓ Event-driven notifications via Kafka


================================================================================
PROJECT STRUCTURE
================================================================================

CheckBus/
├── auth-service/          # Authentication microservice
├── user-service/          # User management microservice
├── ticket-service/        # Ticket management microservice
├── payment_service/       # Payment processing microservice
├── subscription-service/   # Subscription management microservice
├── trajet-service/        # Route management microservice
├── geoloc-service/        # Geolocation tracking microservice
├── notification-service/  # Notification microservice
├── frontend/              # React.js frontend application
├── nginx/                 # Nginx configuration
└── docker-compose.yml     # Docker orchestration file


================================================================================
ENVIRONMENT VARIABLES REQUIRED
================================================================================

- JWT_SECRET: Secret key for JWT token generation
- STRIPE_SECRET_KEY: Stripe API secret key
- STRIPE_CURRENCY: Currency for payments (e.g., "mad", "usd")
- MAIL_ADDR: Email address for sending notifications
- APP_PSSWRD: Application password for email service


================================================================================
END OF DOCUMENT
================================================================================

