@startuml All Services Class Diagram - CheckBus

!define ENTITY_COLOR #E1F5FF
!define SERVICE_COLOR #FFF4E1
!define CONTROLLER_COLOR #E8F5E9
!define DTO_COLOR #F3E5F5
!define REPO_COLOR #FFF9C4

package "Auth Service" #LightBlue {
    
    class UserAuth <<Entity>> ENTITY_COLOR {
        -Long id
        -String username
        -String password
        -String email
        -Boolean isActive
    }
    
    class VerificationToken <<Entity>> ENTITY_COLOR {
        -Long id
        -String token
        -TokenType type
        -LocalDateTime expiresAt
    }
    
    class AuthService <<Service>> SERVICE_COLOR {
        +registerUser(RegisterRequest): UserAuth
        +loginUser(LoginRequest): LoginResponse
        +forgetPassword(String): void
        +resetPassword(String, String): void
    }
    
    class AuthController <<Controller>> CONTROLLER_COLOR {
        +registerUser(RegisterRequest): ResponseEntity
        +loginUser(LoginRequest): ResponseEntity
        +verifyUser(String): ResponseEntity
    }
    
    class UserAuthRepository <<Repository>> REPO_COLOR
    class VerificationTokenRepository <<Repository>> REPO_COLOR
    
    AuthController --> AuthService
    AuthService --> UserAuthRepository
    AuthService --> VerificationTokenRepository
    UserAuthRepository ..> UserAuth
    VerificationTokenRepository ..> VerificationToken
}

package "User Service" #LightGreen {
    
    class User <<Entity>> ENTITY_COLOR {
        -Long id
        -String username
        -String email
        -LocalDateTime createdAt
    }
    
    class UserService <<Service>> SERVICE_COLOR {
        +createUser(CreateUserRequest): User
        +getUserById(Long): Optional<User>
        +getUserByUsername(String): Optional<User>
        +updateUser(User): User
    }
    
    class UserController <<Controller>> CONTROLLER_COLOR {
        +createUser(CreateUserRequest): ResponseEntity
        +getUserById(Long): ResponseEntity
        +getAllUsers(): ResponseEntity
    }
    
    class UserRepository <<Repository>> REPO_COLOR
    
    UserController --> UserService
    UserService --> UserRepository
    UserRepository ..> User
}

package "Ticket Service" #LightYellow {
    
    class Ticket <<Entity>> ENTITY_COLOR {
        -Long id
        -Long userId
        -Long tripId
        -String seatcode
        -TicketStatus status
        -double price
    }
    
    class TicketHistory <<Entity>> ENTITY_COLOR {
        -Long id
        -Ticket ticket
        -TicketStatus previousStatus
        -TicketStatus newStatus
    }
    
    class PaymentInfo <<Entity>> ENTITY_COLOR {
        -Long id
        -Ticket ticket
        -String paymentReference
        -PaymentStatus status
    }
    
    class TicketService <<Service>> SERVICE_COLOR {
        +reserveTicket(TicketRequestDTO): TicketResponseDTO
        +buyTicket(Long, String): TicketResponseDTO
        +changeTicket(Long, TicketRequestDTO): TicketResponseDTO
        +cancelTicket(Long): TicketResponseDTO
    }
    
    class TicketController <<Controller>> CONTROLLER_COLOR {
        +reserveTicket(TicketRequestDTO): ResponseEntity
        +buyTicket(Long, String): ResponseEntity
        +getTicketsByUser(Long): ResponseEntity
    }
    
    class TicketRepository <<Repository>> REPO_COLOR
    class TicketHistoryRepository <<Repository>> REPO_COLOR
    class PaymentInfoRepository <<Repository>> REPO_COLOR
    
    class PaymentClient <<Client>> #FFE0B2
    class TrajetClient <<Client>> #FFE0B2
    class TicketExpirationProducer <<Kafka>> #FFCCBC
    class RefundProducer <<Kafka>> #FFCCBC
    
    TicketController --> TicketService
    TicketService --> TicketRepository
    TicketService --> PaymentClient
    TicketService --> TrajetClient
    TicketService --> TicketExpirationProducer
    TicketService --> RefundProducer
    TicketRepository ..> Ticket
    TicketHistoryRepository ..> TicketHistory
    PaymentInfoRepository ..> PaymentInfo
    Ticket --> PaymentInfo : "1..*"
    TicketHistory --> Ticket : "many-to-one"
}

package "Payment Service" #LightCoral {
    
    class Payment <<Entity>> ENTITY_COLOR {
        -Long id
        -Long ticketId
        -Long subscription_id
        -Double amount
        -PaymentStatus status
        -String paymentReference
    }
    
    class PaymentService <<Service>> SERVICE_COLOR {
        +processPayment(PaymentRequestDTO): PaymentResponseDTO
        +processPayment(PaymentRequestSubDTO): PaymentResponseDTO
        +processRefund(RefundRequestDTO): PaymentResponseDTO
    }
    
    class PaymentController <<Controller>> CONTROLLER_COLOR {
        +processPayment(PaymentRequestDTO): ResponseEntity
        +processSub(PaymentRequestSubDTO): ResponseEntity
        +refundPayment(RefundRequestDTO): ResponseEntity
    }
    
    class PaymentRepository <<Repository>> REPO_COLOR
    class PaymentEventProducer <<Kafka>> #FFCCBC
    
    class Stripe <<External>> #FFCDD2 {
        +PaymentIntent.create(Map): PaymentIntent
        +PaymentIntent.confirm(): PaymentIntent
    }
    
    PaymentController --> PaymentService
    PaymentService --> PaymentRepository
    PaymentService --> PaymentEventProducer
    PaymentService ..> Stripe
    PaymentRepository ..> Payment
}

package "Subscription Service" #LightPink {
    
    class Subscription <<Entity>> ENTITY_COLOR {
        -Long id
        -Long userId
        -PlanType planType
        -double price
        -LocalDateTime startDate
        -LocalDateTime endDate
        -SubscriptionStatus status
        -boolean autoRenew
    }
    
    class SubscriptionService <<Service>> SERVICE_COLOR {
        +createSubscription(Long, PlanType, boolean): Subscription
        +getUserSubscriptions(Long): List<Subscription>
        +cancelAutoRenew(Long): Subscription
        +cancelSubscription(Long): Subscription
    }
    
    class SubscriptionController <<Controller>> CONTROLLER_COLOR {
        +createSubscription(Long, PlanType, boolean): ResponseEntity
        +getByUser(Long): ResponseEntity
        +cancelSubscription(Long): ResponseEntity
    }
    
    class SubscriptionRepository <<Repository>> REPO_COLOR
    class SubscriptionEventProducer <<Kafka>> #FFCCBC
    class UserClient <<Client>> #FFE0B2
    class PaymentClient <<Client>> #FFE0B2
    
    SubscriptionController --> SubscriptionService
    SubscriptionService --> SubscriptionRepository
    SubscriptionService --> UserClient
    SubscriptionService --> PaymentClient
    SubscriptionService --> SubscriptionEventProducer
    SubscriptionRepository ..> Subscription
}

package "Trajet Service" #LightCyan {
    
    class Trajet <<Entity>> ENTITY_COLOR {
        -Long id
        -String ligneCode
        -String depart
        -String arrivee
        -List<String> arrets
        -double distanceKm
        -boolean active
    }
    
    class Horaire <<Entity>> ENTITY_COLOR {
        -Long id
        -Trajet trajet
        -Time heureDepart
        -Time heureArrivee
        -String jour
    }
    
    class TrajetService <<Service>> SERVICE_COLOR {
        +getAllTrajets(): List<TrajetDTO>
        +getTrajetById(Long): TrajetDTO
        +searchTrajets(String, String): List<TrajetDTO>
        +addTrajet(TrajetDTO): TrajetDTO
    }
    
    class TrajetController <<Controller>> CONTROLLER_COLOR {
        +getAll(): ResponseEntity
        +getById(Long): ResponseEntity
        +search(String, String): ResponseEntity
    }
    
    class TrajetRepository <<Repository>> REPO_COLOR
    class HoraireRepository <<Repository>> REPO_COLOR
    class TrajetEventProducer <<Kafka>> #FFCCBC
    
    TrajetController --> TrajetService
    TrajetService --> TrajetRepository
    TrajetService --> TrajetEventProducer
    TrajetRepository ..> Trajet
    HoraireRepository ..> Horaire
    Horaire --> Trajet : "many-to-one"
}

package "Geoloc Service" #LightSteelBlue {
    
    class BusPosition <<Entity>> ENTITY_COLOR {
        -Long id
        -Long busId
        -double latitude
        -double longitude
        -LocalDateTime timestamp
        -BusDirection direction
    }
    
    class BusPositionService <<Service>> SERVICE_COLOR {
        +saveOrUpdatePosition(BusPositionRequestDTO): BusPositionResponseDTO
        +getLatestPosition(Long): Optional<BusPositionResponseDTO>
        +getAllPositions(): List<BusPositionResponseDTO>
    }
    
    class BusPositionController <<Controller>> CONTROLLER_COLOR {
        +updateBusPosition(BusPositionRequestDTO): ResponseEntity
        +getLatestBusPosition(Long): ResponseEntity
        +getAllPositions(): ResponseEntity
    }
    
    class GeoSocketController <<WebSocket>> #C5E1A5 {
        +updateBusPosition(BusPositionRequestDTO): BusPositionResponseDTO
    }
    
    class BusPositionRepository <<Repository>> REPO_COLOR
    class RedisPositionService <<Cache>> #B2DFDB {
        +savePosition(BusPositionResponseDTO): void
        +getPosition(Long): Optional<BusPositionResponseDTO>
    }
    class BusPositionEventProducer <<Kafka>> #FFCCBC
    
    BusPositionController --> BusPositionService
    GeoSocketController --> BusPositionService
    BusPositionService --> BusPositionRepository
    BusPositionService --> RedisPositionService
    BusPositionService --> BusPositionEventProducer
    BusPositionRepository ..> BusPosition
}

package "Notification Service" #LightGray {
    
    class NotificationServiceApplication <<Application>> #E0E0E0 {
        +main(String[]): void
    }
    
    note right of NotificationServiceApplication
        Service minimal
        Structure pour expansion future
    end note
}

' ========== INTER-SERVICE RELATIONSHIPS ==========

' Ticket Service dependencies
TicketService ..> PaymentService : "REST\nPaymentClient"
TicketService ..> TrajetService : "REST\nTrajetClient"

' Subscription Service dependencies
SubscriptionService ..> UserService : "REST\nUserClient"
SubscriptionService ..> PaymentService : "REST\nPaymentClient"

' Kafka Event Flows
PaymentEventProducer ..> TicketService : "Kafka Event\nPaymentEventDTO"
TicketExpirationProducer ..> TicketService : "Kafka Event\nTicketExpirationEvent"
SubscriptionEventProducer ..> NotificationServiceApplication : "Kafka Event\nSubscriptionEvent"
BusPositionEventProducer ..> NotificationServiceApplication : "Kafka Event\nBusPositionEvent"

' Auth Service to User Service (implicit)
AuthService ..> UserService : "Creates User\nProfile"

note top of package "Ticket Service"
    Ticket Service dépend de:
    - Payment Service (paiements)
    - Trajet Service (routes)
end note

note top of package "Subscription Service"
    Subscription Service dépend de:
    - User Service (infos utilisateur)
    - Payment Service (paiements)
end note

note bottom of package "Payment Service"
    Payment Service publie des événements
    Kafka vers Ticket Service
end note

legend right
    |<#ENTITY_COLOR> Entity | JPA Entity |
    |<#SERVICE_COLOR> Service | Business Logic |
    |<#CONTROLLER_COLOR> Controller | REST API |
    |<#REPO_COLOR> Repository | Data Access |
    |<#FFE0B2> Client | REST Client |
    |<#FFCCBC> Kafka | Event Producer/Consumer |
    |<#B2DFDB> Cache | Redis Service |
    |<#C5E1A5> WebSocket | Real-time |
    |<#FFCDD2> External | External Service |
endlegend

@enduml

